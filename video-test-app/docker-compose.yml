# Video-insights (Version A) - Test Deployment
# Deployed on test.askstephen.ai

services:
  # Node.js App
  video-test-app:
    build:
      context: /opt/stacks/video-insights-repo
      dockerfile: /opt/stacks/video-studio-test/Dockerfile
    container_name: video-test-app
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 5000

      # Auth bypass for testing
      BYPASS_AUTH: ${BYPASS_AUTH:-false}
      DEV_USER_ID: ${DEV_USER_ID:-dev_test_user}

      # Database - using same askstephen database
      DATABASE_URL: postgresql://video_studio:${POSTGRES_PASSWORD}@video-studio-db:5432/askstephen

      # Clerk Auth
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY}
      CLERK_PUBLISHABLE_KEY: ${CLERK_PUBLISHABLE_KEY}
      VITE_CLERK_PUBLISHABLE_KEY: ${VITE_CLERK_PUBLISHABLE_KEY}

      # Session
      SESSION_SECRET: ${SESSION_SECRET}

      # Google OAuth (for GDrive)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}

      # Dropbox
      DROPBOX_APP_KEY: ${DROPBOX_APP_KEY}
      DROPBOX_APP_SECRET: ${DROPBOX_APP_SECRET}

      # Leads API
      LEADS_IMPORT_API_KEY: ${LEADS_IMPORT_API_KEY}
      LEADS_WEBHOOK_URL: ${LEADS_WEBHOOK_URL:-}
      BUSINESS_INTELLIGENCE_URL: ${BUSINESS_INTELLIGENCE_URL:-}

      # OpenAI/OpenRouter
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}

      # YouTube Publishing via n8n
      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL:-https://test.askstephen.ai}
      N8N_PUBLISH_URL: ${N8N_PUBLISH_URL:-https://automation.aiautomationauthority.com/webhook/youtube-publish}

      # Video Cuts via n8n (offload ffmpeg to remote server)
      N8N_CUT_URL: ${N8N_CUT_URL:-}
      APP_BASE_URL: ${APP_BASE_URL:-https://test.askstephen.ai}
      FFMPEG_API_URL: ${FFMPEG_API_URL:-}
      FFMPEG_API_KEY: ${FFMPEG_API_KEY:-}
    volumes:
      - video_test_uploads:/app/uploads
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
        reservations:
          memory: 512M
    networks:
      - video-studio-internal
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      - "traefik.http.routers.video-test-app.rule=Host(`test.askstephen.ai`)"
      - "traefik.http.routers.video-test-app.entrypoints=websecure"
      - "traefik.http.routers.video-test-app.tls=true"
      - "traefik.http.routers.video-test-app.tls.certresolver=letsencrypt"
      - "traefik.http.services.video-test-app.loadbalancer.server.port=5000"

networks:
  video-studio-internal:
    external: true
    name: video-studio_video-studio-internal
  traefik-public:
    external: true

volumes:
  video_test_uploads:
