version: '3.8'

# Video Studio - Docker Compose for Hostinger VPS
#
# This stack is designed to work with your existing infrastructure:
# - Traefik (reverse proxy)
# - PostgreSQL (existing database)
# - n8n (automation)
# - Portainer (management)
#
# USAGE:
# 1. Copy .env.example to .env and configure
# 2. Set VIDEO_STUDIO_DOMAIN to your domain
# 3. Set DATABASE_URL to your existing PostgreSQL
# 4. docker-compose up -d --build

services:
  # PostgreSQL Database (OPTIONAL - comment out if using existing PostgreSQL)
  # If you have an existing PostgreSQL, just set DATABASE_URL in .env
  video-studio-db:
    image: postgres:16-alpine
    container_name: video-studio-db
    restart: unless-stopped
    profiles:
      - with-db  # Only starts with: docker-compose --profile with-db up
    environment:
      POSTGRES_DB: video_studio
      POSTGRES_USER: video_studio
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_me_secure_password}
    volumes:
      - video_studio_db_data:/var/lib/postgresql/data
      - ./backend/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - video-studio-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U video_studio -d video_studio"]
      interval: 10s
      timeout: 5s
      retries: 5

  # FastAPI Backend
  video-studio-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: video-studio-api
    restart: unless-stopped
    environment:
      # Database - point to your existing PostgreSQL or use the included one
      # Format: postgresql://user:password@host:port/database
      DATABASE_URL: ${DATABASE_URL:-postgresql://video_studio:${POSTGRES_PASSWORD:-change_me}@video-studio-db:5432/video_studio}

      # Public URL (used for n8n video URLs and CORS)
      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL:-https://${VIDEO_STUDIO_DOMAIN:-video-studio.askstephen.ai}}

      # n8n Webhooks (your existing n8n instance)
      N8N_TRANSCRIBE_URL: ${N8N_TRANSCRIBE_URL}
      N8N_PUBLISH_URL: ${N8N_PUBLISH_URL}
      DEFAULT_LANGUAGE_CODE: ${DEFAULT_LANGUAGE_CODE:-en}

      # OpenRouter AI - uses free/cheap models by default
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      OPENROUTER_MODEL: ${OPENROUTER_MODEL:-google/gemini-2.0-flash-exp:free}
      OPENROUTER_SITE_URL: ${OPENROUTER_SITE_URL:-https://${VIDEO_STUDIO_DOMAIN:-video-studio.askstephen.ai}}
      OPENROUTER_APP_NAME: ${OPENROUTER_APP_NAME:-Video Studio}

      # YouTube OAuth
      YOUTUBE_CLIENT_ID: ${YOUTUBE_CLIENT_ID}
      YOUTUBE_CLIENT_SECRET: ${YOUTUBE_CLIENT_SECRET}
      YOUTUBE_REDIRECT_URI: ${YOUTUBE_REDIRECT_URI:-https://${VIDEO_STUDIO_DOMAIN:-video-studio.askstephen.ai}/oauth/youtube/callback}

      # Storage
      UPLOAD_DIR: /data/uploads
      MAX_UPLOAD_MB: ${MAX_UPLOAD_MB:-2000}

      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-*}

      # Security (optional encryption key for tokens)
      APP_ENCRYPTION_KEY: ${APP_ENCRYPTION_KEY:-}
    volumes:
      - video_studio_uploads:/data/uploads
    networks:
      - video-studio-internal
      - traefik-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-network"

      # API routes - strips /api prefix
      - "traefik.http.routers.video-studio-api.rule=Host(`${VIDEO_STUDIO_DOMAIN:-video-studio.askstephen.ai}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.video-studio-api.entrypoints=websecure"
      - "traefik.http.routers.video-studio-api.tls=true"
      - "traefik.http.routers.video-studio-api.tls.certresolver=${TRAEFIK_CERT_RESOLVER:-cloudflare}"
      - "traefik.http.routers.video-studio-api.service=video-studio-api"
      - "traefik.http.services.video-studio-api.loadbalancer.server.port=8080"
      - "traefik.http.middlewares.video-studio-api-strip.stripprefix.prefixes=/api"
      - "traefik.http.routers.video-studio-api.middlewares=video-studio-api-strip"
      - "traefik.http.routers.video-studio-api.priority=100"

      # Uploads route (serves static files, no strip)
      - "traefik.http.routers.video-studio-uploads.rule=Host(`${VIDEO_STUDIO_DOMAIN:-video-studio.askstephen.ai}`) && PathPrefix(`/uploads`)"
      - "traefik.http.routers.video-studio-uploads.entrypoints=websecure"
      - "traefik.http.routers.video-studio-uploads.tls=true"
      - "traefik.http.routers.video-studio-uploads.tls.certresolver=${TRAEFIK_CERT_RESOLVER:-cloudflare}"
      - "traefik.http.routers.video-studio-uploads.service=video-studio-api"
      - "traefik.http.routers.video-studio-uploads.priority=90"

  # React Frontend (nginx)
  video-studio-web:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: /api
    container_name: video-studio-web
    restart: unless-stopped
    networks:
      - video-studio-internal
      - traefik-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-network"
      - "traefik.http.routers.video-studio-web.rule=Host(`${VIDEO_STUDIO_DOMAIN:-video-studio.askstephen.ai}`)"
      - "traefik.http.routers.video-studio-web.entrypoints=websecure"
      - "traefik.http.routers.video-studio-web.tls=true"
      - "traefik.http.routers.video-studio-web.tls.certresolver=${TRAEFIK_CERT_RESOLVER:-cloudflare}"
      - "traefik.http.services.video-studio-web.loadbalancer.server.port=80"
      - "traefik.http.routers.video-studio-web.priority=1"

networks:
  video-studio-internal:
    driver: bridge
  traefik-network:
    external: true
    name: ${TRAEFIK_NETWORK:-traefik-network}

volumes:
  video_studio_db_data:
  video_studio_uploads:
