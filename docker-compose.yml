version: '3.8'

# Video Studio - Docker Compose for Portainer Deployment
# Uses existing PostgreSQL with askstephen database

services:
  # PostgreSQL Database
  video-studio-db:
    image: postgres:16-alpine
    container_name: video-studio-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: video_studio
      POSTGRES_USER: video_studio
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - video_studio_db_data:/var/lib/postgresql/data
    ports:
      # Expose to localhost only for SSH tunnel access (not public)
      - "127.0.0.1:5432:5432"
    networks:
      - video-studio-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U video_studio -d video_studio"]
      interval: 10s
      timeout: 5s
      retries: 5

  # FastAPI Backend
  video-studio-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: video-studio-api
    restart: unless-stopped
    depends_on:
      video-studio-db:
        condition: service_healthy
    environment:
      # Database - using askstephen database
      DATABASE_URL: postgresql+psycopg2://video_studio:${POSTGRES_PASSWORD}@video-studio-db:5432/askstephen

      # Public URL
      PUBLIC_BASE_URL: https://${VIDEO_STUDIO_DOMAIN}

      # n8n Webhooks
      N8N_TRANSCRIBE_URL: ${N8N_TRANSCRIBE_URL}
      DEFAULT_LANGUAGE_CODE: ${DEFAULT_LANGUAGE_CODE:-en}

      # YouTube OAuth
      YOUTUBE_CLIENT_ID: ${YOUTUBE_CLIENT_ID}
      YOUTUBE_CLIENT_SECRET: ${YOUTUBE_CLIENT_SECRET}
      YOUTUBE_REDIRECT_URI: https://${VIDEO_STUDIO_DOMAIN}/oauth/youtube/callback

      # Storage
      UPLOAD_DIR: /data/uploads
      MAX_UPLOAD_MB: ${MAX_UPLOAD_MB:-2000}

      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-*}

      # Security
      APP_ENCRYPTION_KEY: ${APP_ENCRYPTION_KEY:-}
    volumes:
      - video_studio_uploads:/data/uploads
    networks:
      - video-studio-internal
      - traefik-public
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # API routes - strips /api prefix
      - "traefik.http.routers.video-studio-api.rule=Host(`${VIDEO_STUDIO_DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.video-studio-api.entrypoints=websecure"
      - "traefik.http.routers.video-studio-api.tls=true"
      - "traefik.http.routers.video-studio-api.service=video-studio-api"
      - "traefik.http.services.video-studio-api.loadbalancer.server.port=8080"
      - "traefik.http.middlewares.video-studio-api-strip.stripprefix.prefixes=/api"
      - "traefik.http.routers.video-studio-api.middlewares=video-studio-api-strip"
      - "traefik.http.routers.video-studio-api.priority=100"

      # Uploads route (serves static files, no strip)
      - "traefik.http.routers.video-studio-uploads.rule=Host(`${VIDEO_STUDIO_DOMAIN}`) && PathPrefix(`/uploads`)"
      - "traefik.http.routers.video-studio-uploads.entrypoints=websecure"
      - "traefik.http.routers.video-studio-uploads.tls=true"
      - "traefik.http.routers.video-studio-uploads.service=video-studio-api"
      - "traefik.http.routers.video-studio-uploads.priority=90"

      # OAuth callback route
      - "traefik.http.routers.video-studio-oauth.rule=Host(`${VIDEO_STUDIO_DOMAIN}`) && PathPrefix(`/oauth`)"
      - "traefik.http.routers.video-studio-oauth.entrypoints=websecure"
      - "traefik.http.routers.video-studio-oauth.tls=true"
      - "traefik.http.routers.video-studio-oauth.service=video-studio-web"
      - "traefik.http.routers.video-studio-oauth.priority=80"

  # React Frontend (nginx)
  video-studio-web:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: /api
    container_name: video-studio-web
    restart: unless-stopped
    networks:
      - video-studio-internal
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      - "traefik.http.routers.video-studio-web.rule=Host(`${VIDEO_STUDIO_DOMAIN}`)"
      - "traefik.http.routers.video-studio-web.entrypoints=websecure"
      - "traefik.http.routers.video-studio-web.tls=true"
      - "traefik.http.services.video-studio-web.loadbalancer.server.port=80"
      - "traefik.http.routers.video-studio-web.priority=1"

networks:
  video-studio-internal:
    driver: bridge
  traefik-public:
    external: true

volumes:
  video_studio_db_data:
  video_studio_uploads:
